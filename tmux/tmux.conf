# =============================================================================
# TMUX CONFIGURATION
# =============================================================================

# =============================================================================
# PLUGINS
# =============================================================================
# List of plugins
set -g @plugin 'tmux-plugins/tpm'                    # Plugin manager
set -g @plugin 'tmux-plugins/tmux-sensible'         # Sensible defaults
set -g @plugin 'tmux-plugins/tmux-logging'          # Logging capabilities
set -g @plugin 'tmux-plugins/tmux-sidebar'          # Sidebar navigation
set -g @plugin 'AngryMorrocoy/tmux-neolazygit'      # LazyGit integration
set -g @plugin 'sainnhe/tmux-fzf'                   # Fuzzy finder
set -g @plugin 'b0o/tmux-autoreload'                # Auto-reload config
set -g @plugin 'tmux-plugins/tmux-yank'             # Better copy/paste
set -g @plugin 'tmux-plugins/tmux-open'             # Open files with default apps
set -g @plugin 'tmux-plugins/tmux-copycat'          # Search in tmux
set -g @plugin 'tmux-plugins/tmux-resurrect'        # Save/restore sessions
set -g @plugin 'tmux-plugins/tmux-continuum'        # Auto-save sessions
set -g @plugin 'tmux-plugins/tmux-pain-control'     # Better pane management
set -g @plugin 'tmux-plugins/tmux-sessionist'       # Better session management

# =============================================================================
# PLUGIN SPECIFIC SETTINGS
# =============================================================================
# LazyGit keybinding
set -g @open-lazygit 'G'

# Sidebar settings
set -g @sidebar-tree-command 'tree -C'

# Logging settings
set -g @logging-path '~/.tmux/logs'

# Yank plugin settings
set -g @yank_selection 'primary'
set -g @yank_selection_mouse 'clipboard'

# Resurrect plugin settings
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-vim 'session'
set -g @resurrect-strategy-nvim 'session'

# Continuum plugin settings
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'

# =============================================================================
# BASIC SETTINGS
# =============================================================================
# Enable mouse support
set -g mouse on

# Set prefix to Ctrl+a (like screen)
set -g prefix C-a
unbind C-b
bind C-a send-prefix

# Increase scrollback buffer size
set -g history-limit 50000

# Start window numbering at 1
set -g base-index 1
setw -g pane-base-index 1

# Automatically renumber windows
set -g renumber-windows on

# Set terminal colors
set -g default-terminal "screen-256color"
set -ga terminal-overrides ",xterm-256color:Tc"

# Ensure shell integration works properly
set -g default-shell /opt/homebrew/bin/zsh
set -g default-command /opt/homebrew/bin/zsh

# Set environment variables for proper shell integration
set -g update-environment "DISPLAY SSH_ASKPASS SSH_AUTH_SOCK SSH_CONNECTION SSH_CLIENT SSH_TTY SSH_TTY"

# Ensure XDG directories are properly set
set -g update-environment "XDG_CONFIG_HOME XDG_DATA_HOME XDG_CACHE_HOME ZDOTDIR"

# Set the correct zsh configuration directory
set -g default-command "/opt/homebrew/bin/zsh -l"

# Enable shell integration for better prompt handling
set -g @plugin 'tmux-plugins/tmux-open'
set -g @plugin 'tmux-plugins/tmux-copycat'
set -g @plugin 'tmux-plugins/tmux-yank'

# =============================================================================
# STATUS BAR - DRACULA THEME
# =============================================================================
# Status bar colors (Dracula theme)
set -g status-style bg=#282a36,fg=#f8f8f2

# Status bar position
set -g status-position bottom

# Status bar refresh rate
set -g status-interval 5

# Force status bar to be visible
set -g status on

# Status bar left side: Session and Hostname
set -g status-left-length 50
set -g status-left "#[fg=#bd93f9,bg=#282a36] #{session_name} #[fg=#6272a4]│ #[fg=#f8f8f2,bg=#44475a] #{hostname} "

# Status bar right side: Git status and Date
set -g status-right-length 60
set -g status-right "#[fg=#44475a]│ #[fg=#50fa7b,bg=#282a36] #{git_status} #[fg=#6272a4]│ #[fg=#f8f8f2,bg=#44475a] %a %Y-%m-%d "

# Window status colors
setw -g window-status-style bg=#44475a,fg=#f8f8f2
setw -g window-status-current-style bg=#bd93f9,fg=#282a36,bold

# Window status format
setw -g window-status-format " #I:#W "
setw -g window-status-current-format " #I:#W "

# Pane border colors
set -g pane-border-style bg=#282a36,fg=#44475a
set -g pane-active-border-style bg=#282a36,fg=#bd93f9

# Debug: Show status bar info
bind C-d display "Status: #{status}, Position: #{status-position}, Left: #{status-left}, Right: #{status-right}"

# =============================================================================
# GIT INTEGRATION
# =============================================================================
# Git status function - shows branch name when in git repo
set -g @git-status "#(cd #{pane_current_path} && git branch --show-current 2>/dev/null | sed 's/.*/  󰘬 &/')"

# =============================================================================
# KEYBINDINGS
# =============================================================================
# Reload tmux config
bind r source-file ~/.config/tmux/tmux.conf \; display "Config reloaded!"

# Reload tmux config and install/update plugins
bind R source-file ~/.config/tmux/tmux.conf \; display "Config reloaded! Use prefix + I to install plugins"

# =============================================================================
# PANE MANAGEMENT - IMPROVED
# =============================================================================
# Split panes (more intuitive)
bind v split-window -h -c "#{pane_current_path}"    # Vertical split (left/right)
bind s split-window -v -c "#{pane_current_path}"    # Horizontal split (top/bottom)

# Navigate panes (vim-style)
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Resize panes (vim-style with repeat)
bind -r < resize-pane -L 5
bind -r > resize-pane -R 5
bind -r - resize-pane -D 5
bind -r + resize-pane -U 5

# Alternative resize keys (if you prefer)
bind -r H resize-pane -L 10
bind -r J resize-pane -D 10
bind -r K resize-pane -U 10
bind -r L resize-pane -R 10

# =============================================================================
# PLUGIN KEYBINDINGS
# =============================================================================
# These will work after plugins are installed with prefix + I
bind S run-shell '~/.config/tmux/plugins/tmux-fzf/scripts/session.sh'  # Session switcher
bind G run-shell '~/.config/tmux/plugins/tmux-neolazygit/scripts/neolazygit.sh'  # LazyGit
bind b run-shell '~/.config/tmux/plugins/tmux-sidebar/scripts/sidebar.sh'  # Sidebar toggle

# Search in tmux (copycat) - will work after plugin installation
bind / run-shell '~/.config/tmux/plugins/tmux-copycat/scripts/copycat_grep.sh'
bind ? run-shell '~/.config/tmux/plugins/tmux-copycat/scripts/copycat_git_log.sh'

# =============================================================================
# COPY MODE & YANK
# =============================================================================
# Enter copy mode
bind Escape copy-mode

# Copy selection (yank plugin will handle the rest)
bind y send-keys -X copy-selection-and-cancel

# =============================================================================
# SESSION MANAGEMENT
# =============================================================================
# Create new session
bind C new-session

# Rename session
bind S command-prompt -I "#S" "rename-session '%%'"

# Detach from session (exit tmux)
bind d detach-client

# Kill current session
bind X kill-session

# =============================================================================
# WINDOW MANAGEMENT
# =============================================================================
# Create new window
bind c new-window -c "#{pane_current_path}"

# Rename window
bind , command-prompt -I "#W" "rename-window '%%'"

# Kill window
bind & kill-window

# Next/Previous window
bind n next-window
bind p previous-window

# =============================================================================
# PANE MANAGEMENT
# =============================================================================
# Kill pane
bind x kill-pane

# Toggle pane zoom
bind -r z resize-pane -Z

# Synchronize panes
bind Y set-window-option synchronize-panes \; display "Pane sync: #{?pane_synchronized,on,off}"

# Swap panes
bind '{' swap-pane -U
bind '}' swap-pane -D

# =============================================================================
# UTILITY KEYBINDINGS
# =============================================================================
# Clear history
bind C-l clear-history

# Toggle status bar
bind C-s set-option -g status \; display "Status bar: #{?pane_synchronized,on,off}"

# Display pane numbers
bind t display-panes \; display "Pane numbers shown"

# =============================================================================
# CHEAT SHEET
# =============================================================================
# Display tmux keybinding cheat sheet (stays visible)
bind ? display -d 0 "TMUX CHEAT SHEET:
Pane Management:
  prefix+v = vertical split, prefix+s = horizontal split
  prefix+h/j/k/l = navigate panes
  prefix+</>/+/- = resize panes
  prefix+x = kill pane, prefix+z = zoom pane

Window Management:
  prefix+c = new window, prefix+n/p = next/prev window
  prefix+, = rename window, prefix+& = kill window

Session Management:
  prefix+d = detach, prefix+X = kill session
  prefix+C = new session, prefix+S = rename session

Copy Mode:
  prefix+Escape = enter copy mode
  prefix+y = copy selection

Utility:
  prefix+r = reload config, prefix+t = show pane numbers
  prefix+? = show quick cheat sheet, prefix+C-h = toggle floating cheat sheet"

# LazyGit-style popup cheat sheet (disappears on Escape)
bind C-? display -d 0 "TMUX CHEAT SHEET (Press Escape to close):
Pane Management:
  prefix+v = vertical split, prefix+s = horizontal split
  prefix+h/j/k/l = navigate panes
  prefix+</>/+/- = resize panes
  prefix+x = kill pane, prefix+z = zoom pane

Window Management:
  prefix+c = new window, prefix+n/p = next/prev window
  prefix+, = rename window, prefix+& = kill window

Session Management:
  prefix+d = detach, prefix+X = kill session
  prefix+C = new session, prefix+S = rename session

Copy Mode:
  prefix+Escape = enter copy mode
  prefix+y = copy selection

Utility:
  prefix+r = reload config, prefix+t = show pane numbers
  prefix+? = show quick cheat sheet, prefix+C-h = toggle floating cheat sheet"

# Alternative: Floating window cheat sheet (toggle on/off)
bind C-h if-shell "test -n \"$(tmux list-windows | grep 'cheatsheet')\"" \
  "kill-window -t cheatsheet" \
  "new-window -n cheatsheet -c '#{pane_current_path}' 'cat << \"EOF\"
TMUX CHEAT SHEET
================

Pane Management:
  prefix+v = vertical split, prefix+s = horizontal split
  prefix+h/j/k/l = navigate panes
  prefix+</>/+/- = resize panes
  prefix+x = kill pane, prefix+z = zoom pane

Window Management:
  prefix+c = new window, prefix+n/p = next/prev window
  prefix+, = rename window, prefix+& = kill window

Session Management:
  prefix+d = detach, prefix+X = kill session
  prefix+C = new session, prefix+S = rename session

Copy Mode:
  prefix+Escape = enter copy mode
  prefix+y = copy selection

Utility:
  prefix+r = reload config, prefix+t = show pane numbers
  prefix+? = show quick cheat sheet, prefix+C-h = toggle floating cheat sheet

Press Ctrl+C to close this window
EOF
read -n 1'"

# =============================================================================
# SHELL INTEGRATION
# =============================================================================
# Ensure new panes and windows use the same shell configuration
bind '"' split-window -c "#{pane_current_path}" -l 30
bind % split-window -h -c "#{pane_current_path}" -l 80

# =============================================================================
# INITIALIZE PLUGINS
# =============================================================================
# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.config/tmux/plugins/tpm/tpm'
